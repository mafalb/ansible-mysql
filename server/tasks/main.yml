---

- debug: var=mysql
  tags:
    - never
    - debug

- name: assertions
  assert:
    that:
      - mysql.type is defined
      - mysql.version is defined

- name: include OS specific variables
  include_vars: types.yml

- name: include OS specific variables
  include_vars: "{{ ansible_distribution }}.yml"

- name: assertions
  assert:
    that:
      - mysql.server.manage_package
      - mysql.server.package is defined
      - mysql.server.additional_packages is defined

- name: package is present
  when: mysql.server.manage_package
  package:
    name: "{{ [ mysql.server.package ] + mysql.server.additional_packages }}"
    state: present

- name: my.cnf does exist
  file:
    path: "{{ mysql.server.mysqld_cnf }}"

- name: my.cnf is in place
  when:
    - mysql.server.manage_config
    - not mysql.server.external_config
  template:
    src: server.cnf
    dest: "{{ mysql.server.mysqld_cnf }}"
  notify: reload mysql

- name: my.cnf is in place
  when:
    - mysql.server.manage_config
    - mysql.server.external_config
  template:
    src: server.cnf
    dest: "{{ mysql.server.mysqld_cnf }}"
  notify: reload mysql

- name: mysql service is running
  service:
    name: "{{ mysql.server.service }}"
    state: started
    enabled: true
  register: mysql_is_running

- name: installation is secured
  include_tasks: secure.yml
